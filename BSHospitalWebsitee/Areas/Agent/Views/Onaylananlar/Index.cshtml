@* @{
    ViewData["Title"] = "Onaylananlar";
    Layout = "~/Views/Shared/_AgentLayout.cshtml";
} *@

<h1>Onaylananlar</h1>

<div class="row">
    <div class="col-lg-12 ">
        <div class="card border border-primary">
            <div class="card-header bg-primary border-primary">
                <h5 class="my-0 text-white"><i class="uil uil-message me-3"></i>Onaylananlar</h5>
            </div><!-- end card-header -->
            <div class="card-body">
                <table id="tblOnaylananlar" class="table table-striped table-bordered">
                </table>
            </div><!-- end card-body -->
        </div><!-- end card -->
    </div>
</div>



<form>
    <div class="modal fade" id="modalId" tabindex="-1" role="dialog" aria-labelledby="modalTitleId" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitleId">Yeni bir Randevu Ekle</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="container-fluid">
                        <div class="mb-3 row">
                            <label for="inputName" class="col-4 col-form-label">Hastane Adı</label>
                            <div class="col-8">
                                <select class="form-select" id="ddlHospital" placeholder="Hastane Adı  "></select>
                            </div>
                        </div>

                        <div class="mb-3 row">
                            <label for="inputName" class="col-4 col-form-label">Name Surname</label>
                            <div class="col-8">
                                <input type="text" class="form-control" id="txtName" placeholder="Kullanıcı Adınız ">
                            </div>
                        </div>

                        <div class="mb-3 row">
                            <label for="inputName" class="col-4 col-form-label">TCKN</label>
                            <div class="col-8">
                                <input type="text" class="form-control" id="txtTCKN" placeholder="TC Number ">
                            </div>
                        </div>

                        <div class="mb-3 row">
                            <label for="inputName" class="col-4 col-form-label">Yas</label>
                            <div class="col-8">
                                <input type="number" class="form-control" id="txtYas" placeholder="Yas ">
                            </div>
                        </div>

                        <div class="mb-3 row">
                            <label for="inputName" class="col-4 col-form-label">Adres</label>
                            <div class="col-8">
                                <input type="text" class="form-control" id="txtAdres" placeholder="Adress">
                            </div>
                        </div>

                        <div class="mb-3 row">
                            <label for="inputName" class="col-4 col-form-label">Phone</label>
                            <div class="col-8">
                                <input type="text" class="form-control" id="txtPhone" placeholder="Telefon">
                            </div>
                        </div>

                        <div class="mb-3 row">
                            <label for="inputName" class="col-4 col-form-label">Select Departman</label>
                            <div class="col-8">
                                <select class="form-select" name="script" id="ddlDepartment"> </select>
                            </div>
                        </div>

                        @*  <div class="mb-3 row">
                        <label for="inputName" class="col-4 col-form-label">Select Kullanıcı </label>
                        <div class="col-8">
                        <select class="form-select" name="script" id="ddlUser"> </select>
                        </div>
                        </div> *@

                        @* <div class="mb-3 row">
                        <label for="inputName" class="col-4 col-form-label">Select Patient</label>
                        <div class="col-8">
                        <select class="form-select" name="script" id="ddlPatient"> </select>
                        </div>
                        </div> *@

                        <div class="mb-3 row">
                            <label for="inputName" class="col-4 col-form-label">Select Doctor</label>
                            <div class="col-8">
                                <select class="form-select" name="script" id="ddlDoctor"> </select>
                            </div>
                        </div>
                        <div class="mb-3 row">
                            <label for="inputName" class="col-4 col-form-label">Appointment</label>
                            <div class="col-8">
                                <input type="datetime-local" class="form-control" id="txtAppointment" placeholder="Entry Days ">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <a id="btnAppointment" class="btn btn-primary">Create Appointment</a>
                </div>
            </div>
        </div>
    </div>
</form>


@section Scripts{
    <script type="text/javascript">
        
        $(document).ready(function () {
            onaylananlarListele();
            fillListHospital();
            fillListDoctor();
            fillListDepartment();
        });

        function onaylananlarListele() {
            if ($.fn.DataTable.isDataTable('#tblOnaylananlar')) {
                $('#tblOnaylananlar').DataTable().destroy();
            }
            var DataTable = $("#tblOnaylananlar").DataTable({
                ajax: { url: '/Agent/Onaylananlar/GetAll', dataSrc: '' },
                columns: [
                    { data: 'id', title: 'ID' },
                    { data: 'hospital.hospitalName', title: 'Hastane Adı' },
                    { data: 'patient.patientName', title: 'Hasta Adı' },
                    { data: 'patient.tckn', title: 'TCKN' },
                    { data: 'patient.phone', title: 'Telefon' },
                    { data: 'patient.address', title: 'Adres' },
                    { data: 'patient.age', title: 'Yaş' },
                    { data: 'department.departmantName', title: 'Bölüm Adı' },
                    { data: 'doctor.doctorName', title: 'Doktor Adı' },
                    { data: 'appointmentDate', title: 'Randevu Tarihi' },

                    {
                        data: "id",
                        render: function (data, type, row) {
                            return `<a href="#" onclick="Delete(${data})" class="btn btn-sm btn-danger">Sil</a> <a onclick="Update('${data}','${row.department.departmantName}','${row.hospital.hospitalName}','${row.doctor.doctorName}','${row.patient.patientName}','${row.patient.tckn}','${row.patient.phone}','${row.patient.address}','${row.patient.age}')" class="btn btn-sm btn-primary">Güncelle</a>`;
                        }

                    },

                    {
                        data: "id",
                        render: function (data, type, row) {
                            if (row.IsAccepted) {
                                return `<span class="text-success">Onaylandı</span>`;
                            } else {
                                return '';
                            }
                        }
                    },
                ],
                order: [[9, 'asc']],
            });
        }

        function Delete(id) {
            let deleteee = { id: id }
            $.ajax({
                type: "POST",
                url: '@Url.Action("DeleteById","Onaylananlar")',
                data: deleteee,
                success: function () {
                    Swal.fire({
                        icon: 'success',
                        title: 'Başarılı',
                        message: 'Onaylanan Randevu Silindi',
                        showConfirmButton: false,
                        timer: 1500
                    });
                    $("#tblOnaylananlar").DataTable().ajax.reload();
                }
            })
        }


        // function Update(id, hospitalId, patientName, tckn, age, address, phone, departmantId, doctorId, appointmentDate) {
        //     // $("input").val("");

        //     fillListHospital(hospitalId);
        //     $("#ddlHospital").val(hospitalId);
        //     fillListDepartment(departmantId);
        //     $("#ddlDepartment").val(departmantId);
        //     fillListDoctor(doctorId);
        //     $("#ddlDoctor").val(doctorId);
        //     $("#txtAppointment").val(appointmentDate);

        //     $("#txtName").val(patientName);
        //     $("#txtTCKN").val(tckn);
        //     $("#txtAdres").val(address);
        //     $("#txtPhone").val(phone);
        //     $("#txtYas").val(age);

           
            
        //     $("#modalId").modal("show");
        //     $("#modalTitleId").text("Onaylananlar Güncelle");
        //     $("#btnAppointment").text("Güncelle");
        //     $("#btnAppointment").off();
        //     $("#btnAppointment").click(function () {
        //         $.ajax({
        //             type: "POST",
        //             url: "/Agent/Onaylananlar/Update",
        //             data: {
        //                 id: id,
        //                 hospitalId: $("#ddlHospital").val(),
        //                 departmentId: $("#ddlDepartment").val(),
        //                 doctorId: $("#ddlDoctor").val(),
        //                 appointmentDate: $("#txtAppointment").val(),

        //                 patient: {
        //                     patientName: $("#txtName").val(),
        //                     tckn: $("#txtTCKN").val(),
        //                     address: $("#txtAdres").val(),
        //                     Phone: $("#txtPhone").val(),
        //                     age: $("#txtYas").val(),
        //                     departmentId: $("#ddlDepartment").val(),
        //                 }
        //             },
        //             success: function () {
        //                 alert("Güncelleme Yapıldı");
        //                 $("#modalId").modal("hide");
        //                 $("#tblOnaylananlar").DataTable().ajax.reload();
        //             }
        //         })
        //     })
        // }


        function Update(id, hospitalId, patientName, tckn, age, address, phone, departmantId, doctorId, appointmentDate) {
            // Reset modal content
            $("#ddlHospital, #ddlDepartment, #ddlDoctor").val('');

            // Set values for modal fields
            fillListHospital(hospitalId);
            $("#ddlHospital").val(hospitalId);
            fillListDepartment(departmantId);
            $("#ddlDepartment").val(departmantId);
            fillListDoctor(doctorId);
            $("#ddlDoctor").val(doctorId);
            $("#txtAppointment").val(appointmentDate);

            $("#txtName").val(patientName);
            $("#txtTCKN").val(tckn);
            $("#txtAdres").val(address);
            $("#txtPhone").val(phone);
            $("#txtYas").val(age);

            // Show the modal
            $("#modalId").modal("show");
            $("#modalTitleId").text("Randevu Güncelle ");
            $("#btnAppointment").text("Guncelle");

            // Unbind previous click event
            $("#btnAppointment").off();

            // Bind new click event for update
            $("#btnAppointment").click(function () {
                $.ajax({
                    type: "POST",
                    url: "/Agent/Appointment/Update",
                    data: {
                        id: id,
                        hospitalId: $("#ddlHospital").val(),
                        departmentId: $("#ddlDepartment").val(),
                        doctorId: $("#ddlDoctor").val(),
                        appointmentDate: $("#txtAppointment").val(),

                        patient: {
                            patientName: $("#txtName").val(),
                            tckn: $("#txtTCKN").val(),
                            address: $("#txtAdres").val(),
                            Phone: $("#txtPhone").val(),
                            age: $("#txtYas").val(),
                            departmentId: $("#ddlDepartment").val(),
                        }
                    },
                    success: function () {
                        alert("Güncelleme Yapıldı");
                        $("#modalId").modal("hide");
                        onaylananlarListele();
                    }
                })
            });
        }



        function fillListDoctor(doctorName) {
            $.ajax({
                type: 'GET',
                url: '/Agent/Doctor/GetAll',
                success: function (res) {
                    $("#ddlDoctor").empty();
                    for (var item of res) {
                        $("#ddlDoctor").append(new Option(item.doctorName, item.id, false));
                    }
                }
            })
        }

        function fillListDepartment(departmantId) {
            $.ajax({
                type: 'GET',
                url: '/Agent/Department/GetAll',
                success: function (res) {
                    $("#ddlDepartment").empty();
                    for (var item of res) {
                        $("#ddlDepartment").append(new Option(item.departmantName, item.id, false, item.id == departmantId));
                    }
                }
            })
        }



        function fillListHospital(hospitalId) {
            $.ajax({
                type: 'GET',
                url: '/Agent/Hospital/GetAll',
                success: function (res) {
                    $("#ddlHospital").empty();
                    for (var item of res) {
                        $("#ddlHospital").append(new Option(item.hospitalName, item.id, false, item.id == hospitalId));
                    }
                }
            })
        }


    </script>
}

