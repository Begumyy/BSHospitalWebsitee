
<div class="col-lg">
    <div class="card border border-primary">
        <div class="card-header bg-primary border-primary">
            <h5 class="my-0 text-white"><i class="uil uil-user me-3"></i>Kullanıcı Listesi</h5>
        </div><!-- end card-header -->
        <div class="card-body">

            <table id="tblUsers" class="table table-striped table-bordered dt-responsive nowrap dataTable no-footer dtr-inline" style="border-collapse: collapse; border-spacing: 0px; width: 100%;" role="grid" aria-describedby="datatable-buttons_info">
            </table>
        </div><!-- end card-body -->
    </div><!-- end card -->
</div>

<div class="modal fade" id="modalEdit" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false" role="dialog" aria-labelledby="modalTitleId" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-dialog-centered " role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitleId">Kullanıcı Tipi</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body">
                <div class="container">

                    <div class="mb-3 row">
                        <label for="inputName" class="col-4 col-form-label">Kullanıcı Tipi</label>
                        <div class="col-8">
                            <select id="ddlUserTypes" class="form-select"></select>
                        </div>
                    </div>


                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
                <a href="#" id="btnUpdate" class="btn btn-primary">Güncelle</a>
            </div>

        </div>
    </div>
</div>

@section Scripts{
    <script>

        var DataTable;

        $(document).ready(function () {
            fillDataTable();
            fillUserTypes();
        });

        function fillDataTable() {

            DataTable = $("#tblUsers").DataTable({
                ajax: '/Admin/User/GetAll',
                dom: 'Bfrtip',
                buttons: ["copy", "excel", "pdf", "colvis"],
                columns: [
                    { data: "id", title: 'ID' },
                    { data: "name", title: 'Ad Soyad' },
                    { data: "email", title: 'Email' },
                    { data: "gsm", title: 'GSM' },
                    { data: "userType.name", title: 'Kullanıcı Tipi' },
                    {
                        data: "id", title: 'İşlemler', render: function (data) {
                            return `<a href="#"  onclick="deleteUser(${data})"><i class="uil uil-trash-alt font-size-24 px-3 text-danger"></i><a/>
                                        <a href="#"  onclick="editUser(${data})"><i class="uil uil-pen font-size-24"></i><a/>`;
                        }
                    }
                ],
                language: {
                    url: "//cdn.datatables.net/plug-ins/1.10.25/i18n/Turkish.json"
                },
            });
        }

        function deleteUser(userId) {
            Swal.fire({
                title: "Silmek istediğinizden emin misiniz?",
                showCancelButton: true,
                confirmButtonText: 'Evet',
                cancelButtonText: `Vazgeç`,
            }).then((result) => {
                /* Read more about isConfirmed, isDenied below */
                if (result.isConfirmed) {
                    $.ajax({
                        type: 'POST',
                        url: '/Admin/User/Delete',
                        data: { userId: userId },
                        success: function () {
                            toastr.success("İşlem başarılı", " Kullanıcı Silindi!");
                            DataTable.ajax.reload();
                        }
                    })
                }
            });
        }


        function editUser(userId) {
            $("#modalEdit").modal('show');
            fillUserTypes();

            //şimdi burada işte modalın içindeki buttona bir click event yazmalı ve tıklayınca, ajax ile user update metodunu calıstırmalı ve ona sectiği usertype id ile userıd yi gondermeli, success kısmında da datatable.ajax.reload() çağrılmalı.
            $("#btnUpdate").click(function () {
                var data = { userId: userId, userTypeId: $("#ddlUserTypes").val() }
                //gibi.. burdaki parametre isimlerini artık kendi controllerına göre duzenlemen lazım
                $.ajax({
                    type: 'POST',
                    url: '/Admin/User/Update',
                    data: data,
                    success: function (res) {
                        DataTable.ajax.relaod();
                        $("#modalEdit").modal('hide');

                    }
                })
            });

        }


        function fillUserTypes(userTypeId) {
            $.ajax({
                url: '/Admin/UserType/GetAll',
                success: function (res) {
                    $("#ddlUserTypes").empty();
                    for (var item of res) {
                        $("#ddlUserTypes").append(new Option(item.name, item.id, false, item.id == userTypeId));
                    }
                },
            });

        }

               

    </script>
}